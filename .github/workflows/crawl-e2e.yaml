name: Crawl E2E Test

on:
  push:
    branches:
      - main
      - "feat/**"
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  e2e-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"

      - name: Build site2skill-go
        run: go build -o site2skillgo ./cmd/site2skillgo

      - name: Setup uv (for Python benchmark)
        uses: astral-sh/setup-uv@v4

      - name: Run site2skill-go crawl
        run: |
          echo "=== Running site2skill-go ==="
          time ./site2skillgo generate https://f4ah6o.github.io/site2skill-go/ test-go-skill
          echo ""
          echo "=== Go version results ==="
          find .claude/skills/test-go-skill -type f -name "*.md" | head -20
          find .claude/skills/test-go-skill -type f | wc -l
        continue-on-error: true

      - name: Run Python site2skill crawl (benchmark)
        run: |
          echo "=== Running Python site2skill ==="
          time uvx --from git+https://github.com/laiso/site2skill site2skill \
            https://f4ah6o.github.io/site2skill-go/ test-python-skill
          echo ""
          echo "=== Python version results ==="
          find .claude/skills/test-python-skill -type f -name "*.md" 2>/dev/null | head -20 || echo "No .md files found"
          find .claude/skills/test-python-skill -type f 2>/dev/null | wc -l || echo "0"
        continue-on-error: true

      - name: Compare results
        run: |
          echo "========================================"
          echo "         BENCHMARK COMPARISON"
          echo "========================================"
          echo ""
          echo "--- Go version (site2skill-go) ---"
          GO_FILES=$(find .claude/skills/test-go-skill -type f 2>/dev/null | wc -l || echo "0")
          echo "Total files: $GO_FILES"
          echo ""
          echo "--- Python version (site2skill) ---"
          PY_FILES=$(find .claude/skills/test-python-skill -type f 2>/dev/null | wc -l || echo "0")
          echo "Total files: $PY_FILES"
          echo ""
          echo "========================================"

      - name: Upload Go skill artifact
        uses: actions/upload-artifact@v4
        with:
          name: test-go-skill
          path: .claude/skills/test-go-skill/
        if: always()

      - name: Upload Python skill artifact
        uses: actions/upload-artifact@v4
        with:
          name: test-python-skill
          path: .claude/skills/test-python-skill/
        if: always()

  robots-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"

      - name: Build site2skill-go
        run: go build -o site2skillgo ./cmd/site2skillgo

      - name: Crawl and verify robots.txt compliance
        run: |
          echo "=== Testing robots.txt compliance ==="
          ./site2skillgo generate https://f4ah6o.github.io/site2skill-go/ robots-test-skill

          echo ""
          echo "=== Checking for forbidden content ==="

          # Check if /docs/ng/ content was crawled (SHOULD NOT BE)
          if grep -r "robots.txt BLOCKED" .claude/skills/robots-test-skill/ 2>/dev/null; then
            echo "❌ FAIL: /docs/ng/ content was crawled despite robots.txt disallow!"
            exit 1
          else
            echo "✅ PASS: /docs/ng/ was correctly blocked"
          fi

          # Check if /docs/ja/forbidden/ content was crawled (SHOULD NOT BE)
          if grep -r "禁止コンテンツ" .claude/skills/robots-test-skill/ 2>/dev/null; then
            echo "❌ FAIL: /docs/ja/forbidden/ content was crawled despite robots.txt disallow!"
            exit 1
          else
            echo "✅ PASS: /docs/ja/forbidden/ was correctly blocked"
          fi

          echo ""
          echo "=== robots.txt compliance verified ==="
